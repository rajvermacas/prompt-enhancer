{% extends "base.html" %}

{% block title %}Prompts - Prompt Enhancer{% endblock %}

{% block content %}
<h1 class="text-2xl font-semibold mb-8 text-gray-900">Prompt Editor</h1>

<div class="bg-white rounded-xl border border-gray-100 shadow-sm">
    <div class="border-b border-gray-100">
        <nav class="flex gap-1 px-2 pt-2">
            <button onclick="showTab('categories')" id="tab-categories"
                    class="px-5 py-3 rounded-t-lg font-medium text-sm border-b-2 border-red-600 text-red-600 bg-red-50/50 transition-all duration-200">
                Category Definitions
            </button>
            <button onclick="showTab('fewshots')" id="tab-fewshots"
                    class="px-5 py-3 rounded-t-lg font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-50 transition-all duration-200">
                Few-Shot Examples
            </button>
            <button onclick="showTab('systemprompt')" id="tab-systemprompt"
                    class="px-5 py-3 rounded-t-lg font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-50 transition-all duration-200">
                System Prompt
            </button>
            <!-- AI Improvement Suggestions tab (hidden for future release) -->
            <button onclick="showTab('suggestions')" id="tab-suggestions"
                    class="hidden px-5 py-3 rounded-t-lg font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-50 transition-all duration-200 flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                AI Improvement Suggestions
            </button>
        </nav>
    </div>

    <div id="panel-categories" class="p-6">
        <div id="categories-list" class="space-y-5 mb-6"></div>
        <div class="flex gap-3">
            <button onclick="addCategory()" class="bg-gray-100 text-gray-700 px-5 py-2.5 rounded-lg font-medium hover:bg-gray-200 active:bg-gray-300 transition-all duration-200 hover:-translate-y-0.5 active:translate-y-0">
                + Add Category
            </button>
            <button onclick="saveCategories()" class="bg-red-600 text-white px-5 py-2.5 rounded-lg font-medium hover:bg-red-500 active:bg-red-700 transition-all duration-200 hover:-translate-y-0.5 active:translate-y-0 focus:ring-2 focus:ring-red-600/50 focus:ring-offset-2 focus:outline-none">
                Save Changes
            </button>
        </div>
    </div>

    <div id="panel-fewshots" class="p-6 hidden">
        <div id="fewshots-list" class="space-y-5 mb-6"></div>
        <div class="flex gap-3">
            <button onclick="addFewShot()" class="bg-gray-100 text-gray-700 px-5 py-2.5 rounded-lg font-medium hover:bg-gray-200 active:bg-gray-300 transition-all duration-200 hover:-translate-y-0.5 active:translate-y-0">
                + Add Example
            </button>
            <button onclick="saveFewShots()" class="bg-red-600 text-white px-5 py-2.5 rounded-lg font-medium hover:bg-red-500 active:bg-red-700 transition-all duration-200 hover:-translate-y-0.5 active:translate-y-0 focus:ring-2 focus:ring-red-600/50 focus:ring-offset-2 focus:outline-none">
                Save Changes
            </button>
        </div>
    </div>

    <div id="panel-systemprompt" class="p-6 hidden">
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Custom Instructions for AI Analysis</label>
            <textarea id="system-prompt-content"
                      class="w-full border border-gray-200 rounded-lg px-4 py-3 text-gray-700 focus:border-red-600 focus:ring-2 focus:ring-red-600/20 focus:outline-none transition-all duration-150 resize-none"
                      rows="8"
                      placeholder="Enter additional instructions for the AI analysis (e.g., 'Mention why other categories were not selected')"></textarea>
            <p class="text-sm text-gray-500 mt-2">These instructions will be included in the AI analysis prompt. The response will appear in a "User-Requested Analysis" section.</p>
        </div>
        <button onclick="saveSystemPrompt()" class="bg-red-600 text-white px-5 py-2.5 rounded-lg font-medium hover:bg-red-500 active:bg-red-700 transition-all duration-200 hover:-translate-y-0.5 active:translate-y-0 focus:ring-2 focus:ring-red-600/50 focus:ring-offset-2 focus:outline-none">
            Save Changes
        </button>
    </div>

    <div id="panel-suggestions" class="p-6 hidden">
        <!-- Source Feedback Section (always visible) -->
        <div class="border border-gray-200 rounded-xl p-5 mb-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Source Feedback</h3>
                <span id="feedback-count" class="text-sm text-gray-500"></span>
            </div>
            <p class="text-sm text-gray-500 mb-4">Feedback submissions that will be used for generating improvement suggestions. Delete feedback to exclude it from suggestions.</p>
            <div id="feedbacks-loader" class="hidden">
                <div class="flex items-center justify-center py-8">
                    <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-red-600"></div>
                    <span class="ml-3 text-gray-600">Loading feedback...</span>
                </div>
            </div>
            <div id="source-feedbacks" class="space-y-4"></div>
        </div>

        <!-- Generate Suggestions Button -->
        <div class="mb-6">
            <button onclick="generateSuggestions()" id="generate-suggestions-btn"
                    class="bg-red-600 text-white px-5 py-2.5 rounded-lg font-medium hover:bg-red-500 active:bg-red-700 transition-all duration-200 hover:-translate-y-0.5 active:translate-y-0 focus:ring-2 focus:ring-red-600/50 focus:ring-offset-2 focus:outline-none flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                AI Generate Suggestions
            </button>
        </div>

        <div id="suggestions-loader" class="hidden">
            <div class="flex items-center justify-center py-12">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-red-600"></div>
                <span class="ml-3 text-gray-600">AI Analyzing feedback and generating suggestions...</span>
            </div>
        </div>

        <div id="suggestions-content" class="hidden space-y-6">
            <!-- View Toggle -->
            <div class="flex gap-2">
                <button onclick="setSuggestionView('by-type')" id="view-by-type-btn"
                        class="px-3 py-1.5 text-sm font-medium rounded-lg bg-red-600 text-white transition-colors duration-150">
                    By Suggestion Type
                </button>
                <button onclick="setSuggestionView('by-feedback')" id="view-by-feedback-btn"
                        class="px-3 py-1.5 text-sm font-medium rounded-lg bg-gray-100 text-gray-700 hover:bg-gray-200 transition-colors duration-150">
                    By Feedback Source
                </button>
            </div>

            <!-- By Type View -->
            <div id="suggestions-by-type">
                <!-- Category Suggestions -->
                <div class="border border-gray-200 rounded-xl p-5 mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Category Suggestions</h3>
                    <div id="category-suggestions" class="space-y-3"></div>
                </div>

                <!-- Priority Order -->
                <div class="border border-gray-200 rounded-xl p-5 mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Priority Order</h3>
                    <ol id="priority-order" class="list-decimal list-inside space-y-2 text-gray-700"></ol>
                </div>

                <!-- Suggested Categories (Collapsible) -->
                <div class="border border-gray-200 rounded-xl mb-6">
                    <button onclick="toggleSection('updated-categories')" class="w-full flex items-center justify-between p-5 text-left">
                        <div class="flex items-center gap-3">
                            <h3 class="text-lg font-semibold text-gray-900">Suggested Categories</h3>
                            <span id="updated-categories-count" class="text-sm text-gray-500"></span>
                        </div>
                        <span id="updated-categories-arrow" class="text-gray-400 transition-transform duration-200">&#9654;</span>
                    </button>
                    <div id="updated-categories" class="hidden px-5 pb-5">
                        <div class="flex justify-end mb-3">
                            <button onclick="copyUpdatedCategories()" class="text-sm text-red-600 hover:text-red-700 font-medium">Copy JSON to clipboard</button>
                        </div>
                        <div id="updated-categories-content" class="space-y-3"></div>
                    </div>
                </div>

                <!-- Suggested Few-Shot Examples (Collapsible) -->
                <div class="border border-gray-200 rounded-xl">
                    <button onclick="toggleSection('updated-fewshots')" class="w-full flex items-center justify-between p-5 text-left">
                        <div class="flex items-center gap-3">
                            <h3 class="text-lg font-semibold text-gray-900">Suggested Few-Shot Examples</h3>
                            <span id="updated-fewshots-count" class="text-sm text-gray-500"></span>
                        </div>
                        <span id="updated-fewshots-arrow" class="text-gray-400 transition-transform duration-200">&#9654;</span>
                    </button>
                    <div id="updated-fewshots" class="hidden px-5 pb-5">
                        <div class="flex justify-end mb-3">
                            <button onclick="copyUpdatedFewShots()" class="text-sm text-red-600 hover:text-red-700 font-medium">Copy JSON to clipboard</button>
                        </div>
                        <div id="updated-fewshots-content" class="space-y-3"></div>
                    </div>
                </div>
            </div>

            <!-- By Feedback View -->
            <div id="suggestions-by-feedback" class="hidden space-y-4"></div>
        </div>

        <div id="suggestions-error" class="hidden">
            <div class="bg-red-50 border border-red-200 rounded-xl p-5 text-red-700"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let categories = [];
    let fewShots = [];
    let feedbacks = [];
    let suggestionsData = null;
    let feedbacksLoaded = false;
    let currentSuggestionView = 'by-type';
    let systemPromptContent = '';

    function setSuggestionView(view) {
        currentSuggestionView = view;
        document.getElementById('suggestions-by-type').classList.toggle('hidden', view !== 'by-type');
        document.getElementById('suggestions-by-feedback').classList.toggle('hidden', view !== 'by-feedback');

        const typeBtn = document.getElementById('view-by-type-btn');
        const feedbackBtn = document.getElementById('view-by-feedback-btn');

        if (view === 'by-type') {
            typeBtn.className = 'px-3 py-1.5 text-sm font-medium rounded-lg bg-red-600 text-white transition-colors duration-150';
            feedbackBtn.className = 'px-3 py-1.5 text-sm font-medium rounded-lg bg-gray-100 text-gray-700 hover:bg-gray-200 transition-colors duration-150';
        } else {
            typeBtn.className = 'px-3 py-1.5 text-sm font-medium rounded-lg bg-gray-100 text-gray-700 hover:bg-gray-200 transition-colors duration-150';
            feedbackBtn.className = 'px-3 py-1.5 text-sm font-medium rounded-lg bg-red-600 text-white transition-colors duration-150';
        }
    }

    function showTab(tab) {
        document.getElementById('panel-categories').classList.toggle('hidden', tab !== 'categories');
        document.getElementById('panel-fewshots').classList.toggle('hidden', tab !== 'fewshots');
        document.getElementById('panel-suggestions').classList.toggle('hidden', tab !== 'suggestions');
        document.getElementById('panel-systemprompt').classList.toggle('hidden', tab !== 'systemprompt');

        const tabs = ['categories', 'fewshots', 'suggestions', 'systemprompt'];
        tabs.forEach(t => {
            const tabEl = document.getElementById(`tab-${t}`);
            const isActive = t === tab;
            tabEl.classList.toggle('border-red-600', isActive);
            tabEl.classList.toggle('text-red-600', isActive);
            tabEl.classList.toggle('bg-red-50/50', isActive);
            tabEl.classList.toggle('border-transparent', !isActive);
            tabEl.classList.toggle('text-gray-500', !isActive);
            tabEl.classList.toggle('bg-transparent', !isActive);
        });

        if (tab === 'suggestions' && !feedbacksLoaded) {
            loadFeedbacks();
        }
    }

    function loadFeedbacks() {
        const wsId = getWorkspaceId();
        if (!wsId) return;

        document.getElementById('feedbacks-loader').classList.remove('hidden');
        document.getElementById('source-feedbacks').innerHTML = '';

        fetch(`/api/workspaces/${wsId}/feedback-with-headlines`)
            .then(r => r.json())
            .then(data => {
                feedbacks = data;
                feedbacksLoaded = true;
                renderSourceFeedbacks(feedbacks);
                document.getElementById('feedbacks-loader').classList.add('hidden');
            })
            .catch(err => {
                document.getElementById('feedbacks-loader').classList.add('hidden');
                document.getElementById('source-feedbacks').innerHTML =
                    `<p class="text-red-500 text-sm">Error loading feedback: ${escapeHtml(err.message)}</p>`;
            });
    }

    function deleteFeedback(feedbackId) {
        if (!confirm('Are you sure you want to delete this feedback? This action cannot be undone.')) {
            return;
        }

        const wsId = getWorkspaceId();
        if (!wsId) return;

        fetch(`/api/workspaces/${wsId}/feedback/${feedbackId}`, {
            method: 'DELETE'
        })
        .then(r => {
            if (!r.ok) {
                return r.json().then(err => { throw new Error(err.detail); });
            }
            return r.json();
        })
        .then(() => {
            feedbacks = feedbacks.filter(fb => fb.id !== feedbackId);
            renderSourceFeedbacks(feedbacks);
        })
        .catch(err => {
            alert('Error deleting feedback: ' + err.message);
        });
    }

    function loadPrompts() {
        const wsId = getWorkspaceId();
        if (!wsId) return;

        fetch(`/api/workspaces/${wsId}/prompts/categories`)
            .then(r => r.json())
            .then(data => {
                categories = data.categories;
                renderCategories();
            });

        fetch(`/api/workspaces/${wsId}/prompts/few-shots`)
            .then(r => r.json())
            .then(data => {
                fewShots = data.examples;
                renderFewShots();
            });

        loadSystemPrompt();
    }

    function loadSystemPrompt() {
        const wsId = getWorkspaceId();
        if (!wsId) return;

        fetch(`/api/workspaces/${wsId}/prompts/system-prompt`)
            .then(r => r.json())
            .then(data => {
                systemPromptContent = data.content || '';
                document.getElementById('system-prompt-content').value = systemPromptContent;
            });
    }

    function saveSystemPrompt() {
        const wsId = getWorkspaceId();
        if (!wsId) {
            alert('Please select a workspace first');
            return;
        }

        const content = document.getElementById('system-prompt-content').value;

        fetch(`/api/workspaces/${wsId}/prompts/system-prompt`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({content})
        })
        .then(response => {
            if (response.status === 202) {
                alert('Sent for approval!');
                return;
            } else if (response.status === 409) {
                return response.json().then(data => {
                    alert('Error: ' + data.detail);
                });
            } else {
                systemPromptContent = content;
                alert('System prompt saved!');
            }
        })
        .catch(err => {
            alert('Error saving system prompt: ' + err.message);
        });
    }

    function renderCategories() {
        document.getElementById('categories-list').innerHTML = categories.map((c, i) => `
            <div class="border border-gray-200 rounded-xl p-5 hover:border-gray-300 transition-colors duration-200">
                <input type="text" value="${escapeHtml(c.name)}" onchange="categories[${i}].name=this.value"
                       class="w-full border border-gray-200 rounded-lg px-4 py-2.5 mb-3 text-gray-900 font-medium focus:border-red-600 focus:ring-2 focus:ring-red-600/20 focus:outline-none transition-all duration-150" placeholder="Category Name">
                <textarea onchange="categories[${i}].definition=this.value"
                          class="w-full border border-gray-200 rounded-lg px-4 py-2.5 text-gray-700 focus:border-red-600 focus:ring-2 focus:ring-red-600/20 focus:outline-none transition-all duration-150 resize-none" rows="3" placeholder="Definition...">${escapeHtml(c.definition)}</textarea>
                <button onclick="categories.splice(${i},1);renderCategories()" class="mt-3 text-red-600 text-sm font-medium hover:text-red-700 hover:underline transition-colors duration-150">Remove</button>
            </div>
        `).join('');
    }

    function addCategory() {
        categories.push({name: '', definition: ''});
        renderCategories();
    }

    function saveCategories() {
        const wsId = getWorkspaceId();
        if (!wsId) {
            alert('Please select a workspace first');
            return;
        }
        fetch(`/api/workspaces/${wsId}/prompts/categories`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({categories})
        })
        .then(response => {
            if (response.status === 202) {
                alert('Sent for approval!');
            } else if (response.status === 409) {
                return response.json().then(data => {
                    alert('Error: ' + data.detail);
                });
            } else {
                alert('Categories saved!');
            }
        })
        .catch(err => alert('Error saving categories: ' + err.message));
    }

    function renderFewShots() {
        document.getElementById('fewshots-list').innerHTML = fewShots.map((f, i) => `
            <div class="border border-gray-200 rounded-xl p-5 hover:border-gray-300 transition-colors duration-200">
                <div class="flex items-center gap-2 mb-3">
                    <span class="text-xs font-medium text-gray-500 uppercase tracking-wide">ID:</span>
                    <input type="text" value="${escapeHtml(f.id)}" readonly class="flex-1 border border-gray-100 rounded-lg px-3 py-1.5 text-sm bg-gray-50 text-gray-500">
                </div>
                <div class="space-y-3">
                    <div>
                        <label class="block text-xs font-medium text-gray-500 uppercase tracking-wide mb-1.5">News Content</label>
                        <textarea onchange="fewShots[${i}].news_content=this.value"
                                  class="w-full border border-gray-200 rounded-lg px-4 py-2.5 text-gray-700 focus:border-red-600 focus:ring-2 focus:ring-red-600/20 focus:outline-none transition-all duration-150 resize-none" rows="2" placeholder="Enter news content...">${escapeHtml(f.news_content)}</textarea>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-500 uppercase tracking-wide mb-1.5">Category</label>
                        <input type="text" value="${escapeHtml(f.category)}" onchange="fewShots[${i}].category=this.value"
                               class="w-full border border-gray-200 rounded-lg px-4 py-2.5 text-gray-700 focus:border-red-600 focus:ring-2 focus:ring-red-600/20 focus:outline-none transition-all duration-150" placeholder="Category name">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-500 uppercase tracking-wide mb-1.5">Reasoning</label>
                        <textarea onchange="fewShots[${i}].reasoning=this.value"
                                  class="w-full border border-gray-200 rounded-lg px-4 py-2.5 text-gray-700 focus:border-red-600 focus:ring-2 focus:ring-red-600/20 focus:outline-none transition-all duration-150 resize-none" rows="2" placeholder="Explain the categorization...">${escapeHtml(f.reasoning)}</textarea>
                    </div>
                </div>
                <button onclick="fewShots.splice(${i},1);renderFewShots()" class="mt-4 text-red-600 text-sm font-medium hover:text-red-700 hover:underline transition-colors duration-150">Remove example</button>
            </div>
        `).join('');
    }

    function addFewShot() {
        fewShots.push({id: 'ex-' + Date.now(), news_content: '', category: '', reasoning: ''});
        renderFewShots();
    }

    function saveFewShots() {
        const wsId = getWorkspaceId();
        if (!wsId) {
            alert('Please select a workspace first');
            return;
        }
        fetch(`/api/workspaces/${wsId}/prompts/few-shots`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({examples: fewShots})
        })
        .then(response => {
            if (response.status === 202) {
                alert('Sent for approval!');
            } else if (response.status === 409) {
                return response.json().then(data => {
                    alert('Error: ' + data.detail);
                });
            } else {
                alert('Few-shots saved!');
            }
        })
        .catch(err => alert('Error saving few-shots: ' + err.message));
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text || '';
        return div.innerHTML;
    }

    function generateSuggestions() {
        const wsId = getWorkspaceId();
        if (!wsId) {
            alert('Please select a workspace first');
            return;
        }

        document.getElementById('suggestions-loader').classList.remove('hidden');
        document.getElementById('suggestions-content').classList.add('hidden');
        document.getElementById('suggestions-error').classList.add('hidden');
        document.getElementById('generate-suggestions-btn').disabled = true;

        fetch(`/api/workspaces/${wsId}/suggest-improvements`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        })
        .then(r => {
            if (!r.ok) {
                return r.json().then(err => { throw new Error(err.detail); });
            }
            return r.json();
        })
        .then(data => {
            suggestionsData = data;
            renderSuggestions(data);
            document.getElementById('suggestions-loader').classList.add('hidden');
            document.getElementById('suggestions-content').classList.remove('hidden');
        })
        .catch(err => {
            document.getElementById('suggestions-loader').classList.add('hidden');
            document.getElementById('suggestions-error').classList.remove('hidden');
            document.getElementById('suggestions-error').querySelector('div').textContent = err.message;
        })
        .finally(() => {
            document.getElementById('generate-suggestions-btn').disabled = false;
        });
    }

    function renderSuggestions(data) {
        // Update feedbacks with latest data from suggestions response
        feedbacks = data.feedbacks;
        renderSourceFeedbacks(feedbacks);
        renderCategorySuggestions(data.suggestions.category_suggestions, data.feedbacks);
        renderPriorityOrder(data.suggestions.priority_order);
        renderUpdatedCategories(data.suggestions.updated_categories);
        renderUpdatedFewShots(data.suggestions.updated_few_shots);
        renderSuggestionsByFeedback(data);
    }

    function renderSourceFeedbacks(feedbackList) {
        const container = document.getElementById('source-feedbacks');
        const countEl = document.getElementById('feedback-count');

        if (!feedbackList || feedbackList.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-sm">No feedback available. Submit feedback on articles in the News section to see it here.</p>';
            countEl.textContent = '0 items';
            return;
        }

        countEl.textContent = `${feedbackList.length} item${feedbackList.length !== 1 ? 's' : ''}`;

        container.innerHTML = feedbackList.map(fb => `
            <div class="bg-gray-50 rounded-lg p-4 border border-gray-100" id="feedback-card-${fb.id}">
                <div class="flex items-start justify-between mb-2">
                    <h4 class="font-medium text-gray-900 flex-1">${escapeHtml(fb.article_headline)}</h4>
                    <div class="flex items-center gap-2 flex-shrink-0 ml-2">
                        <span class="${fb.thumbs_up ? 'text-green-600' : 'text-red-600'}">
                            ${fb.thumbs_up ? '&#128077;' : '&#128078;'}
                        </span>
                        <button onclick="deleteFeedback('${fb.id}')"
                                class="text-gray-400 hover:text-red-600 transition-colors duration-150"
                                title="Delete feedback">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                ${!fb.thumbs_up && fb.correct_category ? `
                    <div class="text-sm text-gray-600 mb-2">
                        <span class="font-medium">Correct category:</span> ${escapeHtml(fb.correct_category)}
                    </div>
                ` : ''}
                <div class="text-sm text-gray-600 mb-2">
                    <span class="font-medium">User reasoning:</span> ${escapeHtml(fb.reasoning)}
                </div>
                <div class="text-sm text-gray-500 mb-3">
                    <span class="font-medium">AI insight:</span> ${escapeHtml(fb.ai_insight.category)} (${Math.round(fb.ai_insight.confidence * 100)}% confidence)
                </div>
                <div class="border-t border-gray-200 pt-3">
                    <button onclick="toggleFeedbackContent('${fb.id}')"
                            class="text-sm text-gray-600 hover:text-gray-800 flex items-center gap-1">
                        <span id="feedback-content-arrow-${fb.id}" class="transition-transform duration-200">&#9654;</span>
                        <span>Article Content</span>
                    </button>
                    <div id="feedback-content-${fb.id}" class="hidden mt-2 max-h-48 overflow-y-auto bg-white border border-gray-100 rounded p-3 text-sm text-gray-700 whitespace-pre-wrap">
                        ${escapeHtml(fb.article_content || '')}
                    </div>
                </div>
            </div>
        `).join('');
    }

    function toggleFeedbackContent(feedbackId) {
        const content = document.getElementById(`feedback-content-${feedbackId}`);
        const arrow = document.getElementById(`feedback-content-arrow-${feedbackId}`);
        content.classList.toggle('hidden');
        arrow.style.transform = content.classList.contains('hidden') ? '' : 'rotate(90deg)';
    }

    function renderCategorySuggestions(suggestions, feedbacks) {
        const container = document.getElementById('category-suggestions');
        if (!suggestions || suggestions.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-sm">No category suggestions.</p>';
            return;
        }

        container.innerHTML = suggestions.map(s => {
            const feedbackLinks = (s.based_on_feedback_ids || []).map(id => {
                const fb = feedbacks.find(f => f.id === id);
                return fb
                    ? `<a href="#feedback-card-${id}" onclick="highlightFeedback('${id}')" class="text-red-600 hover:underline">${escapeHtml(fb.article_headline)}</a>`
                    : id;
            }).join(', ');

            const quotes = (s.user_reasoning_quotes || []).map(q =>
                `<div class="text-xs text-gray-500 italic mt-1">"${escapeHtml(q)}"</div>`
            ).join('');

            return `
                <div class="bg-gray-50 rounded-lg p-4 border border-gray-100">
                    <div class="font-medium text-gray-900 mb-1">${escapeHtml(s.category || s.suggestion || 'Suggestion')}</div>
                    <div class="text-sm text-gray-600">${escapeHtml(s.rationale || s.description || '')}</div>
                    ${feedbackLinks ? `<div class="text-xs text-gray-500 mt-2">Based on: ${feedbackLinks}</div>` : ''}
                    ${quotes}
                </div>
            `;
        }).join('');
    }

    function highlightFeedback(feedbackId) {
        const card = document.getElementById(`feedback-card-${feedbackId}`);
        if (card) {
            card.scrollIntoView({ behavior: 'smooth', block: 'center' });
            card.classList.add('ring-2', 'ring-red-500');
            setTimeout(() => card.classList.remove('ring-2', 'ring-red-500'), 2000);
        }
    }

    function renderSuggestionsByFeedback(data) {
        const container = document.getElementById('suggestions-by-feedback');
        const feedbacksList = data.feedbacks || [];
        const catSuggestions = data.suggestions.category_suggestions || [];
        const fewShotSuggestions = data.suggestions.few_shot_suggestions || [];

        const cards = feedbacksList.map(fb => {
            const relatedCatSuggestions = catSuggestions.filter(s =>
                (s.based_on_feedback_ids || []).includes(fb.id)
            );
            const relatedFewShotSuggestions = fewShotSuggestions.filter(s =>
                s.based_on_feedback_id === fb.id
            );

            if (relatedCatSuggestions.length === 0 && relatedFewShotSuggestions.length === 0) {
                return '';
            }

            return `
                <div class="border border-gray-200 rounded-xl p-5">
                    <div class="flex items-center gap-2 mb-3">
                        <span class="${fb.thumbs_up ? 'text-green-600' : 'text-red-600'}">
                            ${fb.thumbs_up ? '&#128077;' : '&#128078;'}
                        </span>
                        <h4 class="font-medium text-gray-900">${escapeHtml(fb.article_headline)}</h4>
                    </div>
                    <div class="text-sm text-gray-600 mb-3">User said: "${escapeHtml(fb.reasoning)}"</div>

                    ${relatedCatSuggestions.length > 0 ? `
                        <div class="mb-3">
                            <div class="text-xs font-medium text-gray-500 uppercase mb-2">Category Suggestions</div>
                            ${relatedCatSuggestions.map(s => `
                                <div class="bg-white border border-gray-100 rounded p-3 mb-2">
                                    <div class="font-medium text-sm">${escapeHtml(s.category)}</div>
                                    <div class="text-xs text-gray-600">${escapeHtml(s.rationale)}</div>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}

                    ${relatedFewShotSuggestions.length > 0 ? `
                        <div>
                            <div class="text-xs font-medium text-gray-500 uppercase mb-2">Few-Shot Suggestions</div>
                            ${relatedFewShotSuggestions.map(s => `
                                <div class="bg-white border border-gray-100 rounded p-3 mb-2">
                                    <span class="text-xs px-2 py-0.5 rounded-full ${s.source === 'user_article' ? 'bg-blue-100 text-blue-800' : 'bg-purple-100 text-purple-800'}">
                                        ${s.source === 'user_article' ? 'From this article' : 'Synthetic'}
                                    </span>
                                    <span class="text-xs px-2 py-0.5 rounded-full bg-gray-100 text-gray-800 ml-1">
                                        ${escapeHtml(s.action)}
                                    </span>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
        }).filter(Boolean);

        if (cards.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-sm">No suggestions linked to specific feedback.</p>';
        } else {
            container.innerHTML = cards.join('');
        }
    }

    function renderPriorityOrder(priorities) {
        const container = document.getElementById('priority-order');
        if (!priorities || priorities.length === 0) {
            container.innerHTML = '<li class="text-gray-500 text-sm">No priorities specified.</li>';
            return;
        }
        container.innerHTML = priorities.map(p => `<li>${escapeHtml(p)}</li>`).join('');
    }

    function renderUpdatedCategories(updatedCategories) {
        const container = document.getElementById('updated-categories-content');
        const countEl = document.getElementById('updated-categories-count');

        if (!updatedCategories || updatedCategories.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-sm">No updated categories.</p>';
            countEl.textContent = '';
            return;
        }

        countEl.textContent = `${updatedCategories.length} update${updatedCategories.length !== 1 ? 's' : ''}`;

        container.innerHTML = updatedCategories.map(cat => {
            const feedbackLinks = (cat.based_on_feedback_ids || []).map(id => {
                const fb = feedbacks.find(f => f.id === id);
                return fb
                    ? `<a href="#feedback-card-${id}" onclick="highlightFeedback('${id}')" class="text-red-600 hover:underline">${escapeHtml(fb.article_headline)}</a>`
                    : id;
            }).join(', ');

            return `
                <div class="bg-gray-50 rounded-lg p-4 border border-gray-100">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                        ${escapeHtml(cat.category)}
                    </span>
                    <div class="text-sm text-gray-700 mt-3">
                        <span class="font-medium">Updated definition:</span>
                        <p class="mt-1 whitespace-pre-wrap">${escapeHtml(cat.updated_definition)}</p>
                    </div>
                    ${cat.rationale ? `
                        <div class="text-sm text-gray-600 mt-2">
                            <span class="font-medium">Rationale:</span> ${escapeHtml(cat.rationale)}
                        </div>
                    ` : ''}
                    ${feedbackLinks ? `<div class="text-xs text-gray-500 mt-2">Based on: ${feedbackLinks}</div>` : ''}
                </div>
            `;
        }).join('');
    }

    function renderUpdatedFewShots(updatedFewShots) {
        const container = document.getElementById('updated-fewshots-content');
        const countEl = document.getElementById('updated-fewshots-count');

        if (!updatedFewShots || updatedFewShots.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-sm">No updated few-shot examples.</p>';
            countEl.textContent = '';
            return;
        }

        countEl.textContent = `${updatedFewShots.length} update${updatedFewShots.length !== 1 ? 's' : ''}`;

        const actionColors = {
            add: 'bg-green-100 text-green-800',
            modify: 'bg-yellow-100 text-yellow-800',
            remove: 'bg-red-100 text-red-800'
        };

        container.innerHTML = updatedFewShots.map(item => {
            const action = item.action || 'modify';
            const example = item.example || {};
            const colorClass = actionColors[action] || 'bg-gray-100 text-gray-800';

            if (action === 'remove') {
                return `
                    <div class="bg-gray-50 rounded-lg p-4 border border-gray-100">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${colorClass}">
                                ${escapeHtml(action.toUpperCase())}
                            </span>
                            <span class="text-sm font-medium text-gray-900">${escapeHtml(example.id || 'Unknown ID')}</span>
                        </div>
                        <p class="text-sm text-gray-500 italic">This example will be removed</p>
                    </div>
                `;
            }

            return `
                <div class="bg-gray-50 rounded-lg p-4 border border-gray-100">
                    <div class="flex items-center gap-2 mb-3">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${colorClass}">
                            ${escapeHtml(action.toUpperCase())}
                        </span>
                        <span class="text-sm font-medium text-gray-700">${escapeHtml(example.id || 'New Example')}</span>
                        ${example.category ? `
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                ${escapeHtml(example.category)}
                            </span>
                        ` : ''}
                    </div>
                    ${example.news_content ? `
                        <div class="mb-3">
                            <span class="text-xs font-medium text-gray-500 uppercase tracking-wide">News Content</span>
                            <p class="mt-1 text-sm text-gray-700 whitespace-pre-wrap">${escapeHtml(example.news_content)}</p>
                        </div>
                    ` : ''}
                    ${example.reasoning ? `
                        <div>
                            <span class="text-xs font-medium text-gray-500 uppercase tracking-wide">Reasoning</span>
                            <p class="mt-1 text-sm text-gray-700 whitespace-pre-wrap">${escapeHtml(example.reasoning)}</p>
                        </div>
                    ` : ''}
                </div>
            `;
        }).join('');
    }

    function toggleSection(sectionId) {
        const section = document.getElementById(sectionId);
        const arrow = document.getElementById(sectionId + '-arrow');
        section.classList.toggle('hidden');
        arrow.style.transform = section.classList.contains('hidden') ? '' : 'rotate(90deg)';
    }

    function copyUpdatedCategories() {
        if (!suggestionsData || !suggestionsData.suggestions.updated_categories) {
            alert('No updated categories to copy');
            return;
        }
        const json = JSON.stringify(suggestionsData.suggestions.updated_categories, null, 2);
        navigator.clipboard.writeText(json).then(() => alert('Copied JSON to clipboard!'));
    }

    function copyUpdatedFewShots() {
        if (!suggestionsData || !suggestionsData.suggestions.updated_few_shots) {
            alert('No updated few-shot examples to copy');
            return;
        }
        const json = JSON.stringify(suggestionsData.suggestions.updated_few_shots, null, 2);
        navigator.clipboard.writeText(json).then(() => alert('Copied JSON to clipboard!'));
    }

    document.getElementById('workspace-selector').addEventListener('change', () => {
        feedbacksLoaded = false;
        loadPrompts();
    });
    if (getWorkspaceId()) loadPrompts();
</script>
{% endblock %}
