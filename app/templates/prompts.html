{% extends "base.html" %}

{% block title %}Prompts - Prompt Enhancer{% endblock %}

{% block content %}
<h1 class="text-2xl font-semibold mb-8 text-gray-900">Prompt Editor</h1>

<div class="bg-white rounded-xl border border-gray-100 shadow-sm">
    <div class="border-b border-gray-100">
        <nav class="flex gap-1 px-2 pt-2">
            <button onclick="showTab('categories')" id="tab-categories"
                    class="px-5 py-3 rounded-t-lg font-medium text-sm border-b-2 border-red-600 text-red-600 bg-red-50/50 transition-all duration-200">
                Category Definitions
            </button>
            <button onclick="showTab('fewshots')" id="tab-fewshots"
                    class="px-5 py-3 rounded-t-lg font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-50 transition-all duration-200">
                Few-Shot Examples
            </button>
        </nav>
    </div>

    <div id="panel-categories" class="p-6">
        <div id="categories-list" class="space-y-5 mb-6"></div>
        <div class="flex gap-3">
            <button onclick="addCategory()" class="bg-gray-100 text-gray-700 px-5 py-2.5 rounded-lg font-medium hover:bg-gray-200 active:bg-gray-300 transition-all duration-200 hover:-translate-y-0.5 active:translate-y-0">
                + Add Category
            </button>
            <button onclick="saveCategories()" class="bg-red-600 text-white px-5 py-2.5 rounded-lg font-medium hover:bg-red-500 active:bg-red-700 transition-all duration-200 hover:-translate-y-0.5 active:translate-y-0 focus:ring-2 focus:ring-red-600/50 focus:ring-offset-2 focus:outline-none">
                Save Changes
            </button>
        </div>
    </div>

    <div id="panel-fewshots" class="p-6 hidden">
        <div id="fewshots-list" class="space-y-5 mb-6"></div>
        <div class="flex gap-3">
            <button onclick="addFewShot()" class="bg-gray-100 text-gray-700 px-5 py-2.5 rounded-lg font-medium hover:bg-gray-200 active:bg-gray-300 transition-all duration-200 hover:-translate-y-0.5 active:translate-y-0">
                + Add Example
            </button>
            <button onclick="saveFewShots()" class="bg-red-600 text-white px-5 py-2.5 rounded-lg font-medium hover:bg-red-500 active:bg-red-700 transition-all duration-200 hover:-translate-y-0.5 active:translate-y-0 focus:ring-2 focus:ring-red-600/50 focus:ring-offset-2 focus:outline-none">
                Save Changes
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let categories = [];
    let fewShots = [];

    function showTab(tab) {
        document.getElementById('panel-categories').classList.toggle('hidden', tab !== 'categories');
        document.getElementById('panel-fewshots').classList.toggle('hidden', tab !== 'fewshots');

        const catTab = document.getElementById('tab-categories');
        const fsTab = document.getElementById('tab-fewshots');

        catTab.classList.toggle('border-red-600', tab === 'categories');
        catTab.classList.toggle('text-red-600', tab === 'categories');
        catTab.classList.toggle('bg-red-50/50', tab === 'categories');
        catTab.classList.toggle('border-transparent', tab !== 'categories');
        catTab.classList.toggle('text-gray-500', tab !== 'categories');
        catTab.classList.toggle('bg-transparent', tab !== 'categories');

        fsTab.classList.toggle('border-red-600', tab === 'fewshots');
        fsTab.classList.toggle('text-red-600', tab === 'fewshots');
        fsTab.classList.toggle('bg-red-50/50', tab === 'fewshots');
        fsTab.classList.toggle('border-transparent', tab !== 'fewshots');
        fsTab.classList.toggle('text-gray-500', tab !== 'fewshots');
        fsTab.classList.toggle('bg-transparent', tab !== 'fewshots');
    }

    function loadPrompts() {
        const wsId = getWorkspaceId();
        if (!wsId) return;

        fetch(`/api/workspaces/${wsId}/prompts/categories`)
            .then(r => r.json())
            .then(data => {
                categories = data.categories;
                renderCategories();
            });

        fetch(`/api/workspaces/${wsId}/prompts/few-shots`)
            .then(r => r.json())
            .then(data => {
                fewShots = data.examples;
                renderFewShots();
            });
    }

    function renderCategories() {
        document.getElementById('categories-list').innerHTML = categories.map((c, i) => `
            <div class="border border-gray-200 rounded-xl p-5 hover:border-gray-300 transition-colors duration-200">
                <input type="text" value="${escapeHtml(c.name)}" onchange="categories[${i}].name=this.value"
                       class="w-full border border-gray-200 rounded-lg px-4 py-2.5 mb-3 text-gray-900 font-medium focus:border-red-600 focus:ring-2 focus:ring-red-600/20 focus:outline-none transition-all duration-150" placeholder="Category Name">
                <textarea onchange="categories[${i}].definition=this.value"
                          class="w-full border border-gray-200 rounded-lg px-4 py-2.5 text-gray-700 focus:border-red-600 focus:ring-2 focus:ring-red-600/20 focus:outline-none transition-all duration-150 resize-none" rows="3" placeholder="Definition...">${escapeHtml(c.definition)}</textarea>
                <button onclick="categories.splice(${i},1);renderCategories()" class="mt-3 text-red-600 text-sm font-medium hover:text-red-700 hover:underline transition-colors duration-150">Remove</button>
            </div>
        `).join('');
    }

    function addCategory() {
        categories.push({name: '', definition: ''});
        renderCategories();
    }

    function saveCategories() {
        const wsId = getWorkspaceId();
        if (!wsId) {
            alert('Please select a workspace first');
            return;
        }
        fetch(`/api/workspaces/${wsId}/prompts/categories`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({categories})
        }).then(() => alert('Categories saved!'));
    }

    function renderFewShots() {
        document.getElementById('fewshots-list').innerHTML = fewShots.map((f, i) => `
            <div class="border border-gray-200 rounded-xl p-5 hover:border-gray-300 transition-colors duration-200">
                <div class="flex items-center gap-2 mb-3">
                    <span class="text-xs font-medium text-gray-500 uppercase tracking-wide">ID:</span>
                    <input type="text" value="${escapeHtml(f.id)}" readonly class="flex-1 border border-gray-100 rounded-lg px-3 py-1.5 text-sm bg-gray-50 text-gray-500">
                </div>
                <div class="space-y-3">
                    <div>
                        <label class="block text-xs font-medium text-gray-500 uppercase tracking-wide mb-1.5">News Content</label>
                        <textarea onchange="fewShots[${i}].news_content=this.value"
                                  class="w-full border border-gray-200 rounded-lg px-4 py-2.5 text-gray-700 focus:border-red-600 focus:ring-2 focus:ring-red-600/20 focus:outline-none transition-all duration-150 resize-none" rows="2" placeholder="Enter news content...">${escapeHtml(f.news_content)}</textarea>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-500 uppercase tracking-wide mb-1.5">Category</label>
                        <input type="text" value="${escapeHtml(f.category)}" onchange="fewShots[${i}].category=this.value"
                               class="w-full border border-gray-200 rounded-lg px-4 py-2.5 text-gray-700 focus:border-red-600 focus:ring-2 focus:ring-red-600/20 focus:outline-none transition-all duration-150" placeholder="Category name">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-500 uppercase tracking-wide mb-1.5">Reasoning</label>
                        <textarea onchange="fewShots[${i}].reasoning=this.value"
                                  class="w-full border border-gray-200 rounded-lg px-4 py-2.5 text-gray-700 focus:border-red-600 focus:ring-2 focus:ring-red-600/20 focus:outline-none transition-all duration-150 resize-none" rows="2" placeholder="Explain the categorization...">${escapeHtml(f.reasoning)}</textarea>
                    </div>
                </div>
                <button onclick="fewShots.splice(${i},1);renderFewShots()" class="mt-4 text-red-600 text-sm font-medium hover:text-red-700 hover:underline transition-colors duration-150">Remove example</button>
            </div>
        `).join('');
    }

    function addFewShot() {
        fewShots.push({id: 'ex-' + Date.now(), news_content: '', category: '', reasoning: ''});
        renderFewShots();
    }

    function saveFewShots() {
        const wsId = getWorkspaceId();
        if (!wsId) {
            alert('Please select a workspace first');
            return;
        }
        fetch(`/api/workspaces/${wsId}/prompts/few-shots`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({examples: fewShots})
        }).then(() => alert('Few-shots saved!'));
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text || '';
        return div.innerHTML;
    }

    document.getElementById('workspace-selector').addEventListener('change', loadPrompts);
    if (getWorkspaceId()) loadPrompts();
</script>
{% endblock %}
